<canvas id="ctx" width="500" height="500" style="border: 1px solid #000000;"></canvas>

<script>
 var ctx = document.getElementById('ctx').getContext("2d");
 ctx.font = '30px Ariel';
 var WIDTH = 500;
 var HEIGHT = 500;

 var timeWhenGameStarted = Date.now();
 var frameCount = 0;
 var score = 0;

 Entity = function(type,id,x,y,spdX,spdY,width,height,color){
    var self={
        type:type,
        id:id,
        x:x,
        y:y,
        spdX:spdX,
        spdY:spdY,
        width: width,
        height:height,
        color
    }
    return self;


 }
 //player
 

 createPlayer = function(){
    self = Entity('player','myid',50,40,30,5,20,20,'green')
        self.hp = 10,
        self.atkSpd = 1,
        self.attackCounter = 0,
        self.pressingUp = false,
        self.pressingDown = false,
        self.pressingLeft = false,
        self.pressingRight = false,
        self.aimAngle = 0

        player = self;
 }

var enemyList = {};
var upgradeList = {};
var bulletList = {};

 

getDistanceBetweenEntity = function (entity1,entity2){
     var vx = entity1.x - entity2.x;
     var vy = entity1.y - entity2.y;
     return Math.sqrt(vx*vx + vy*vy);
 }

 testCollisionEntity = function(entity1,entity2){
     var rect1 = {
         x:entity1.x-entity1.width/2,
         y:entity1.y-entity1.height/2,
         width:entity1.width,
         height:entity1.height
     }
     var rect2 = {
         x:entity2.x-entity2.width/2,
         y:entity2.y-entity2.height/2,
         width:entity2.width,
         height:entity2.height
     }
     return testCollisionRectRect(rect1,rect2)
 }

 Enemy = function(id,x,spdX,y,spdY,width,height){
     var self = Entity('enemy',id,x,y,spdX,spdY,width,height,'red');
         self.hp = 10; 
         self.aimAngle = 0,
         self.atkSpd = 1,
         self.attackCounter = 0
    
         enemyList[id] = self;

 }

 upgrade = function (id,x,spdX,y,spdY,width,height,category,color){
     var self = Entity('upgrade',id,x,y,spdX,spdY,width,height,color);
         self.category = category;
         upgradeList[id] = self;

 }

 Bullet = function (id,x,spdX,y,spdY,width,height){
     var self = Entity('enemy',id,x,y,spdX,spdY,width,height,'black');
         self.timer = 0
         bulletList[id] = self;

 }

 randomlyGenerateEnemy = function(){
     var x = Math.random()*WIDTH;
     var y = Math.random()* HEIGHT;
     var height = 10 + Math.random()*30;
     var width = 10 + Math.random()*30;
     var id = Math.random();
     var spdX = 5 + Math.random()*5;
     var spdY = 5 + Math.random()*5;
     Enemy(id,x,spdX,y,spdY,width,height);
 }

 randomlyGenerateUpgrade = function(){
     var x = Math.random()*WIDTH;
     var y = Math.random()* HEIGHT;
     var height = 10;
     var width = 10;
     var id = Math.random();
     var spdX = 0;
     var spdY = 0;

     if(Math.random() < 0.5){
         var category = 'score';
         var color = 'orange';
     }
     else{
         var category = 'atkSpd';
         var color = 'purple';
     }
     upgrade(id,x,spdX,y,spdY,width,height,category,color);
 }
 generateBullets = function(actor,overWriteAngle){
     var x = actor.x;
     var y = actor.y;
     var height = 10;
     var width = 10;
     var id = Math.random();
     var angle = actor.aimAngle;
     if(overWriteAngle !== undefined){
         angle = overWriteAngle;
     }
     var spdX = Math.cos(angle/180 * Math.PI)*5;
     var spdY = Math.sin(angle/180 * Math.PI)*5;
     Bullet(id,x,spdX,y,spdY,width,height);
 }
 

 document.onmousemove = function(mouse){
     var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
     var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

     player.x = mouseX;
     player.y = mouseY;

     player.aimAngle = Math.atan2(mouseX,mouseY) / Math.PI * 180;
 }

 document.onkeydown = function(event){
     if(event.keyCode === 68)//d
       player.pressingRight = true;
     else if(event.keyCode === 83)//s
        player.pressingDown = true;
     else if(event.keyCode === 65)//a
        player.pressingLeft = true;
     else if(event.keyCode === 87)//w
         player.pressingUp = true;
 }

 document.onkeyup = function(event){
     if(event.keyCode === 68)//d
       player.pressingRight = false;
     else if(event.keyCode === 83)//s
        player.pressingDown = false;
     else if(event.keyCode === 65)//a
        player.pressingLeft = false;
     else if(event.keyCode === 87)//w
         player.pressingUp = false;
 }

 updateEntity = function(entity){
     updateEntityPosition(entity); 
     drawEntity(entity);
 }

 updateEntityPosition = function(something){

    if(something.type == 'player'){
        if(player.pressingRight)
          player.x += 10;
        if(player.pressingLeft)
          player.x -= 10;
        if(player.pressingDown) 
          player.y += 10;
        if(player.pressingUp)
          player.y -= 10; 
        
        //isPositionValid
        if(player.x < player.width/2)
          player.x = player.width/2;
        if(player.x > WIDTH-player.width/2)
          player.x = WIDTH-player.width/2;

        if(player.y < player.height/2)
          player.y = player.height/2;
        if(player.y > HEIGHT-player.height/2)
           player.y = HEIGHT-player.height/2;

    }else{

        something.x +=something.spdX;
         something.y +=something.spdY;
    
         
         if(something.x < 0 || something.x > WIDTH){
             something.spdX = -something.spdX;
         }
         if(something.y<0 || something.y > HEIGHT){
             something.spdY = -something.spdY;
         }
    }
 }

testCollisionRectRect = function(rect1,rect2){
    return rect1.x <= rect2.x + rect2.width && rect2.x <= rect1.x + rect1.width && rect1.y <=rect2.y+rect2.height &&rect2.y <= rect1.y + rect1.height;
}

 drawEntity = function(something){
     ctx.save();
     ctx.fillStyle = something.color;
     ctx.fillRect(something.x-something.width/2,something.y-something.height/2,something.width,something.height);
     ctx.restore();
 }

 document.onclick = function(mouse){
    performAttack(player);
 }

 performAttack = function(actor){
    if(actor.attackCounter > 25){
         generateBullets(actor);
         actor.attackCounter = 0;
     }
 }

 document.oncontextmenu = function(mouse){//on right click
     performSpecialAttack(player);
     mouse.preventDefault();
 }

 performSpecialAttack = function(actor){
    if(actor.attackCounter > 1){
         /*for(angle = 0; angle <= 360; angle ++){
            generateBullets(actor,angle);
         }*/

         generateBullets(actor,actor.aimAngle-5);
         generateBullets(actor,actor.aimAngle);
         generateBullets(actor,actor.aimAngle+5);

         actor.attackCounter = 0;
     }
 }
 var counter = 0;
 update = function(){
     ctx.clearRect(0,0,WIDTH,HEIGHT);

     frameCount ++;
     score ++;
     if(frameCount % 100 === 0){
         randomlyGenerateEnemy();
     }

     if(frameCount % 75 === 0){
         randomlyGenerateUpgrade();
     }
     player.attackCounter += player.atkSpd;
     

     for(var key in bulletList){
         updateEntity(bulletList[key]);

         var toRemove = false;
         bulletList[key].timer ++;

         if(bulletList[key].timer > 75){
             toRemove = true;
         }

         for(var key2 in enemyList){
            var isColliding = testCollisionEntity(bulletList[key],enemyList[key2]);

            if(isColliding){
                delete bulletList[key]
                delete enemyList[key2];
                break;
            }
         }
         if(toRemove){
             delete bulletList[key];
         }
     }

     for(var key in upgradeList){
         updateEntity(upgradeList[key]);

         var isColliding = testCollisionEntity(player,upgradeList[key]);

         if(isColliding){
             if(upgradeList[key].category === 'score'){
                 score += 1000;
             }
             if(upgradeList[key].category === 'atkSpd'){
                 player.atkSpd += 3;
             }
             delete upgradeList[key];

         }
     }
     
     for(var key in enemyList){
         updateEntity(enemyList[key]);
         var isColliding = testCollisionEntity(player,enemyList[key]);

         if(isColliding){
             player.hp = player.hp - 1;

         }
        }

        if(player.hp <=0){
                 var timeSurvived = Date.now() - timeWhenGameStarted;
                 console.log('You lost! You survived for '+ timeSurvived + "ms"); 
                 startNewGame();
         }

        updateEntity(player);
        ctx.fillText(player.hp + ' HP',0,30);
        ctx.fillText("Score: " + score,200,30);
    }

    startNewGame = function(){
        player.hp = 10;
        whenGameStarted = Date.now();
        score = 0;
        frameCount = 0;
        enemyList = {};
        upgradeList = {};
        bulletList = {};
        randomlyGenerateEnemy();
        randomlyGenerateEnemy();
        randomlyGenerateEnemy();
    }
    createPlayer();
    startNewGame();
    setInterval(update,40);

</script>  